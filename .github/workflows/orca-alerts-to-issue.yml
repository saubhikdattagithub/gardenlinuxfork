name: Orca Security Alerts → GitHub Issue

on:
  schedule:
    - cron: "*/5 * * * *"   # every 15 days at 09:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  orca-alerts:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Orca alerts
        id: orca
        env:
          ORCA_API_TOKEN: ${{ secrets.ORCA_API_TOKEN }}
        run: |
          set -euo pipefail

        curl -X POST 'https://app.eu.sap.orcasecurity.io/api/serving-layer/query'         -H 'authority: app.eu.sap.orcasecurity.io'         -H 'accept: application/json, text/plain, */*'         -H 'accept-language: en-US,en;q=0.9'         -H 'authorization: TOKEN {{ORCA_API_TOKEN}}'         -H 'content-type: application/json'         --data-raw '{
          "query": {
            "models": [
              "Alert"
            ],
            "type": "object_set",
            "with": {
              "operator": "and",
              "type": "operation",
              "values": [
                {
                  "key": "RiskLevel",
                  "values": [
                    "critical",
                    "high",
                    "medium"
                  ],
                  "type": "str",
                  "operator": "in"
                },
                {
                  "key": "Status",
                  "values": [
                    "open",
                    "in_progress"
                  ],
                  "type": "str",
                  "operator": "in"
                }
              ]
            }
          },
          "limit": 100,
          "start_at_index": 0,
          "order_by[]": [
            "-OrcaScore"
          ],
          "group_by[]": [
            "AlertType"
          ],
          "get_results_and_count": false,
          "debug_enable_bu_tags": true,
          "max_tier": 2
        }'         --compressed > alerts.json

#          curl -s -X POST "$API" \
#            -H "Authorization: Bearer $ORCA_API_TOKEN" \
#            -H "Content-Type: application/json" \
#            -d '{
#              "filters": {
#                "state": ["open"],
#                "severity": ["High", "Critical", "Medium"],
#                "business_unit": ["garden-linux"]
#              },
#              "limit": 200
#            }' > alerts.json

          echo "=== RAW ORCA RESPONSE ==="
          cat alerts.json
          echo "========================="
          
          COUNT=$(jq '.data // [] | length' alerts.json)
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          jq -r '
          (.data // [])[]
          | "- **\(.title // "No title")** (Severity: \(.severity // "N/A"))\n  Resource: \(.asset_name // "N/A")\n  Link: \(.console_link // "N/A")"
          ' alerts.json > alert_list.md

      - name: Create GitHub issue
        if: steps.orca.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const alerts = fs.readFileSync('alert_list.md', 'utf8');

            const title = `Orca Security Alerts (Garden Linux) – ${new Date().toISOString().slice(0,10)}`;

            const body = `**Unit:** Garden Linux **Generated:** ${new Date().toUTCString()} ${alerts} ';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["security", "orca", "garden-linux"]
            });
